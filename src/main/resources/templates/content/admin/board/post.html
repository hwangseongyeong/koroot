<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/default">

<div layout:fragment="content">

    <section id="contact" class="contact">
        <div class="container" data-aos="fade-up">
            <div class="row">
                <div class="col-lg-12">
                    <h3><span>관리자 게시판</span></h3>
                </div>
            </div>

            <table id="table"
                   data-toggle="table"
                   data-pagination="true"
                   data-search="true"
                   data-show-columns="true"
                   data-halign="center"
                   data-url="/admin/api/boardListAll"
            >
            </table>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalPost">등록</button>
            </div>
        </div>

    </section>

    <div id="modalPost" class="modal fade" tabindex="-1" aria-hidden="true">
        <form id="saveFrm"  method="post">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">게시물 - 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#modalPost" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <table class="table table-bordered">
                        <tbody>
                        <tr>
                            <th class="w-25">게시물 TYPE</th>
                            <td class="w-auto">
                                <select id="type" name="type" class="form-select">
                                    <option value="">선택해주세요.</option>
                                    <option value="NOTICE">공지 사항</option>
                                    <option value="ACCOUNTING">투명한 재정, 회계 보고</option>
                                    <option value="IMAGE">이미지</option>
                                    <option value="BOOK_STORY">책 이야기</option>
                                    <option value="SUPPORT_STATUS">후원 현황</option>
                                    <option value="PUBLICATION">발간 자료</option>
                                    <option value="VIDEO">영상 자료</option>
                                    <option value="PRESS">언론 보도</option>
                                    <option value="VOICE">해외입양인 목소리</option>
                                    <option value="STORY">김도현 목사의 해외입양 이야기</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th class="w-25">제목</th>
                            <td class="w-auto">
                                <div class="input-group mb-3">
                                    <input id="title" name="title" type="text" class="form-control">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th class="w-25">내용</th>
                            <td class="w-auto">
                                <textarea id="contents" class="form-control"></textarea>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>
                <div class="modal-footer">
                    <button  type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#modalPost">닫기</button>
                    <button id="saveBtn" type="button" class="btn btn-primary">저장</button>
                </div>
            </div>
        </div>
        </form>
    <th:block layout:fragment="script">
<!--        <script th:src="@{/js/communication/notice.js}"></script>-->
        <script src="https://cdn.ckeditor.com/ckeditor5/27.0.0/classic/ckeditor.js"></script>

        <script type="text/javascript">
            let editor;
            ClassicEditor
                .create( document.querySelector( '#contents' ),{
                    // ckfinder: {
                    //     uploadUrl: '/base/ckeditor/fileUpload'
                    // }
                }).then( newEditor => {
                editor = newEditor;
            })
                .catch( error => {
                    console.error( error );
                } );

            $(function(){
                $('#table').bootstrapTable('destroy').bootstrapTable({
                    height: 578,
                    locale: "ko-KR",
                    columns: [
                        {
                            title: '게시글ID',
                            field: 'boardId',
                            width: 40,
                            align: 'center'
                        },{
                            title: '게시판 유형',
                            field: 'type',
                            align: 'center'
                        },{
                            title: '게시판 카테고리',
                            field: 'category',
                            align: 'center'
                        },{
                            title: '제목',
                            field: 'title',
                            align: 'center'
                        },{
                            title: '등록일',
                            field: 'createdAt',
                            align: 'center'
                        },{
                            title: '조회수',
                            field: 'hits',
                            align: 'center'
                        }
                    ]
                });

                $("#saveBtn").on({
                    click:function(){
                        if( !$("#type").val() ){
                            alert("게시판 유형을 선택해주세요.");
                            return false;
                        }

                        commAjax.post("/admin/api/boardCreate", {
                            "type": $("#type").val(),
                            "title": $("#title").val(),
                            "contents": editor.getData()
                        })
                        .then(function(result){
                            if(!result.error){
                                alert("등록되었습니다.");
                            }
                            else{
                                alert("오류가 발생하였습니다.");
                            }
                        });
                    }
                });
                $('#table').on('click-row.bs.table', function (e, rowData) {
                    console.log(e,rowData);

                    const params = {
                        "boardId": rowData.boardId
                    }

                    commAjax.get("/admin/api/boardFindOne", params)
                    .then(function(result){
                        if(!result.error){
                            console.log("result :: ", result);
                            $("#modalPost").modal("show");

                            setBoardData(result);
                        }
                        else{
                            alert("오류가 발생하였습니다.");
                        }
                    });
                });
            });

            function setBoardData(result){
                $("#type").val(result.type);
                $("#title").val(result.title);
                editor.setData(result.contents);
            }
        </script>
    </th:block>

    <style type="text/css">
        .page-link {
            color:#000000
        }
        .page-item.active .page-link{
            background-color:#48bd2b
        }
        .ck-editor__editable_inline {
            min-height: 400px;
        }
        .bootstrap-table .fixed-table-container .fixed-table-body {
            overflow: hidden;
            position: relative;
        }
    </style>
</div>

</html>